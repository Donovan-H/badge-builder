<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/juicy-html/juicy-html.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../behaviors/document-behavior.html">

<link rel="import" href="../quiz-elements/quiz-single.html">
<link rel="import" href="../quiz-elements/quiz-multiple.html">
<link rel="import" href="../quiz-elements/quiz-ordered-list.html">
<link rel="import" href="../content-video/content-video.html">
<link rel="import" href="../content-html/content-html.html">
<link rel="import" href="../content-button/content-button.html">
<link rel="import" href="../content-section/content-section.html">
<link rel="import" href="../quiz-elements/quiz-short-input.html">
<link rel="import" href="../quiz-elements/quiz-long-input.html">

<link rel="import" href="../../bower_components/Sortable/Sortable.html">

<dom-module id="create-badge">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      ::content #components > *{
        margin-top: 10px;
        margin-bottom: 10px;
      }

      ::content paper-material {
        padding: 10px;
        box-sizing: border-box;
        background: white;
      }

      ::content div > .option {
        margin-right: 30px;
      }

      ::content .content {
        position: relative;
        padding-bottom: 60px;
      }

      ::content .content .widgets {
        position: absolute;
        bottom: 10px;
      }

      ::content paper-fab.widget {
        display: inline-block;
      }

      ::content paper-fab.delete {
        position: absolute;
        /*transform: translateY(-50%);
        top: 50%;*/
        right: 10px;
        bottom: 10px;
      }

      ::content .drag-handle {
        position: absolute;
        top: 0;
        right: 0;
      }

      span,
      input {
        @apply(--paper-font-body2);
      }

      #fab {
        position: fixed;
        bottom: 10px;
        right: 10px;
        z-index: 1;
      }

      #fab > paper-fab {
        margin-top: 10px;
      }

      paper-fab.blue {
        --paper-fab-background: var(--paper-light-blue-500);
        --paper-fab-keyboard-focus-background: var(--paper-light-blue-900);
      }
    </style>

    <iron-signals on-iron-signal-create="opened"></iron-signals>
    <iron-ajax id="getBadge"
      handle-as="json" on-response="badgeResponse" last-response="{{response}}" >
    </iron-ajax>

    <iron-ajax id="createBadge" handle-as="json" content-type="application/json"
      url="/api/author/badges" method="POST"
      on-response="handleCreateResponse">
    </iron-ajax>

    <iron-ajax id="updateBadge" handle-as="json" content-type="application/json"
      method="PUT" on-response="handleUpdateResponse">
    </iron-ajax>

    <paper-material class="content">
      <h2 class="page-title">[[title]]</h2>

      <paper-input id="titleInput" placeholder="Title" label="Badge Title" value="{{badgeTitle}}" autofocus required></paper-input>

      <paper-input id="keyInput" placeholder="Key" label="Consumer Key" value="{{badgeKey}}"></paper-input>
      <paper-input id="secretInput" placeholder="Secret" label="Consumer Secret" value="{{badgeSecret}}"></paper-input>

      <paper-dropdown-menu label="Badge Theme">
        <paper-listbox id="theme" class="dropdown-content" attr-for-selected="value" selected="{{badgeTheme}}" on-iron-select="selectTheme">
          <paper-item value="blue"><span class="swatch bg_blue"></span>Blue</paper-item>
          <paper-item value="green"><span class="swatch bg_green"></span>Green</paper-item>
          <paper-item value="pink"><span class="swatch bg_pink"></span>Pink</paper-item>
          <paper-item value="orange"><span class="swatch bg_orange"></span>Orange</paper-item>
        </paper-listbox>
      </paper-dropdown-menu>

      <paper-button on-tap="saveBadge" raised><iron-icon icon="save"></iron-icon>{{saveTitle}}</paper-button>

      <paper-button on-tap="_test" raised><iron-icon icon="bug-report"></iron-icon>Test</paper-button>
    </paper-material>


    <div id="fab">
        <!-- Quiz -->
        <paper-fab icon="radio-button-checked" on-tap="createYesNo"></paper-fab>
        <paper-fab icon="check-box" on-tap="createMultipleChoice"></paper-fab>
        <paper-fab icon="editor:format-line-spacing" on-tap="createQuizOrderedList"></paper-fab>
        <paper-fab icon="av:shuffle" on-tap="createQuizDraggable"></paper-fab>
        <paper-fab icon="editor:short-text" on-tap="createQuizShortInput"></paper-fab>
        <paper-fab icon="editor:format-align-left" on-tap="createQuizLongInput"></paper-fab>
        <!-- Content -->
        <paper-fab icon="editor:format-color-text" on-tap="createHTML" class="blue"></paper-fab>
        <paper-fab icon="av:videocam" on-tap="createVideo" class="blue"></paper-fab>
        <paper-fab icon="link" on-tap="createButton" class="blue"></paper-fab>
        <!--iframe 2.0-->
        <!-- <paper-fab icon="av:play-circle-outline" on-tap="" class="blue"></paper-fab> -->
        <!--section divider-->
        <paper-fab icon="remove" on-tap="createContentSection" class="blue"></paper-fab>
    </div>

    <!-- dynamic elements go inside here -->
    <div id="components"></div>
  </template>



  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'create-badge',
        properties: {
          _node : {
            type: Object,
            value: {
              elements: []
            }
          },
          elements : {
            type: Array,
            value: []
          },
          isEditMode : {
            type: Boolean,
            value: true,
            observer: '_changeEditMode'
          },
          title: {
            type: String,
            value: "Create Badge"
          },
          id: {
            type: String
          },
          saveTitle: {
            type: String
          },
          badgeTitle: {
            type: String,
            notifiy: true
          },
          badgeKey: {
            type: String,
            notifiy: true
          },
          badgeSecret: {
            type: String,
            notifiy: true
          },
          _sortable: {
            type: Object
          }
        },

        opened: function (event) {
          this._resetPage();
          // edit mode
          if (event.detail && event.detail.params){
            var id = event.detail.params._id;
            console.log(this.localName, "opened", id);
            this.set('id', id);
            this.$.getBadge.url = '/api/author/badges/' + id;
            this.$.getBadge.generateRequest();
            return;
          }
        },

        _changeEditMode: function(isEditMode) {
          console.log("mode", isEditMode);
          if (isEditMode){
            this.set('title', "Edit Badge");
            this.set('saveTitle', "Update");
            return;
          }
          this.set('saveTitle', "Save");
          this.set('title', "Create Badge");
          // enable drag & drop when switching into edit mode
          if (this._sortable) {
            console.log('->', this._sortable.options.disabled);
            this._sortable.options.disabled = (this.isEdit) ? false : true;
          }
        },

        selectTheme: function(event) {
          //var theme = event.detail.item.id;
          console.log("select theme:", this.badgeTheme);
          this._setAppTheme(this.badgeTheme);
        },

        saveBadge: function (event) {
          this._updateElements();
          var body = {
            title: this.$.titleInput.value,
            content: {
              theme: this.badgeTheme,
              elements: this.elements
            },
            consumerKey: this.$.keyInput.value,
            consumerSecret: this.$.secretInput.value
          };
          console.info(this.localName, 'save', body);
          if (this.isEditMode) {
            this.$.updateBadge.url = '/api/author/badges/' + this.id;
            this.$.updateBadge.body = body;
            this.$.updateBadge.generateRequest();
          } else {
            this.$.createBadge.body = body;
            this.$.createBadge.generateRequest();
          }
        },

        handleCreateResponse: function (event) {
          app.$.toast.text = 'Badge Saved';
          app.$.toast.show();
          page.redirect(app.baseUrl);
          this._resetPage();
        },

        handleUpdateResponse: function (event) {
          app.$.toast.text = 'Badge Updated';
          app.$.toast.show();
        },

        // TODO: clean-up dynamic elements / resources
        _resetPage: function(){
          this.$.titleInput.value = '';
          this.$.theme.selected = ''; // clear theme selection
          this._setAppTheme('none');
          // detatch custom elements
          var i = this._node.elements.length;
          while(i--){
            var el = this._node.elements[i];
            console.info(this.localName, '-', el);
            Polymer.dom(this.$.components).removeChild(el.element); // TODO: check elements are being detached
          }
          this._node = {
            elements: []
          };
          this.elements = [];
        },

        _onDeleteElement: function(event) {
          var target = event.target;
          console.log("- delete", event.target);
          var i = this._node.elements.length;
          while(i--){
            var el = this._node.elements[i].element;
            if (el === target) {
              console.log("delete element:", el);
              console.log("befor:", this._node.elements);
              Polymer.dom(this.$.components).removeChild(el); // TODO: check elements are being detached
              this.splice('_node.elements',i,1); // remove from array
              console.log("after:", this._node.elements);
              return;
            }
          }
        },

        addContentSection: function(title) {
          var el = new ContentSection(); //document.createElement("content-section");
          el.title = title;

          this.addElement(el);
        },

        createContentSection: function() {
          this.addContentSection("Section");
        },

        addVideo: function(embededURI) {
          var el = new ContentVideo(); // var el = document.createElement("content-video");
          el.embededURI = embededURI;

          this.addElement(el);
        },

        createVideo: function() {
          this.addVideo();
        },

        addHTML: function(text) {
          var el = new ContentHTML();
          el.text = text;

          this.addElement(el);
        },

        createHTML: function() {
          this.addHTML();
        },

        addButton: function(buttonURL, buttonText) {
          var el = new ContentButton();
          el.buttonURL = buttonURL;
          el.buttonText = buttonText;

          this.addElement(el);
        },

        createButton: function() {
          this.addButton();
        },

        addQuizShortInput: function(id, question, answerKeywords, answer) {
          var el = new QuizShortInput();
          el._id = id;
          el.question = question;
          el.answerKeywords = answerKeywords;
          el.answer = answer;

          this.addElement(el);
        },

        createQuizShortInput: function() {
          this.addQuizShortInput();
        },

        addQuizLongInput: function(id, question, answer, wordLimit) {
          var el = new QuizLongInput();
          el._id = id;
          el.question = question;
          el.answer = answer;
          el.wordLimit = wordLimit;

          this.addElement(el);
        },

        createQuizLongInput: function() {
          this.addQuizLongInput();
        },

        // _elementsChanged: function(changeRecord){
        //   //console.info(this.localName, '*', changeRecord, this._node.elements);
        // },

        _updateElements: function(){
          this.set('elements', this._getElementsData());
        },

        _getElementsData: function(){
          var elementsData = [];
          var elements = Polymer.dom(this.$.components).querySelectorAll('.draggable'); //this._node.elements
          var i = elements.length;
          while(i--){
            var el = elements[i]; //elements[i].element;
            var data = el.getData();
            console.log('json', data);
            elementsData.unshift(data); // reverse order
          }
          console.log("elementsData:", elementsData);
          return elementsData;
        },

        _test: function(){
          this._updateElements();
          console.info(this.localName, 'DATA', this.elements); // this._node.elements
        },

        createYesNo: function(){
          var el = document.createElement('quiz-single');
          el.options = ["Yes","No"];
          this.addElement(el);
        },

        createMultipleChoice: function(){
          var el = document.createElement('quiz-multiple');
          this.addElement(el);
        },

        createQuizOrderedList: function(){
          var el = document.createElement('quiz-ordered-list');
          this.addElement(el);
        },

        createQuizDraggable: function(){
          console.log("TODO"); //TODO
        },

        addQuizElementType: function(elementType, id, question, options, answer) {
          var el = document.createElement(elementType);
          el._id = id;
          el.question = question;
          el.options = options;
          el.answer = answer;
          //
          this.addElement(el);
        },

        addElement: function (element) {
          element.edit = true;
          element.classList.add("draggable");
          Polymer.dom(this.$.components).appendChild(element);
          this.push('_node.elements', {element: element});
        },

        // EDIT
        badgeResponse: function(event) {
          var elements = this.response.content.elements;
          console.log(this.localName, 'edit', this.response.content);
          this.set('badgeTitle', this.response.title);
          this.set('badgeKey', this.response.consumerKey);
          this.set('badgeSecret', this.response.consumerSecret);
          this.set('badgeTheme', this.response.content.theme);

          for (var i=0; i<elements.length; i++) {
            var element = elements[i];
            switch(element.elementType) {
                case "content-video":
                    this.addVideo(element.embededURI);
                    break;
                case "content-html":
                    this.addHTML(element.text);
                    break;
                case "content-button":
                    this.addButton(element.buttonURL, element.buttonText);
                    break;
                case "quiz-short-input":
                    this.addQuizShortInput(element._id, element.question, element.answerKeywords, element.answer);
                    break;
                case "quiz-long-input":
                    this.addQuizLongInput(element._id, element.question, element.answer, element.wordLimit);
                    break;
                case "content-section":
                    this.addContentSection(element.title);
                    break;
                default:
                  this.addQuizElementType(element.elementType, element._id, element.question, element.options, element.answer); // generic quiz elements
                  break;
            }
          }
        },

        _applyDragAndDrop: function() {
          var container = this.$.components;
          console.log("container", container);
          this._sortable = Sortable.create(container, {
            draggable: ".draggable",
            handle: ".drag-handle",
            disabled: !this.isEditMode,
            scroll: true,
            animation: 200
          });
        },

        attached: function() {
          this._applyDragAndDrop();
        },

        detached: function() {
          if (this._sortable) {
            this._sortable.destroy();
          }
        },

        // observers: [
        //   '_elementsChanged(_node.elements.length)'
        // ],

        listeners: {
          'deleteElement': "_onDeleteElement"
        },

        behaviors: [
          Page.DocumentBehavior
        ]
      });
    })();
  </script>
</dom-module>
